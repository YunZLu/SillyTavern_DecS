<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 酒馆解密服务</title>

    <!-- 引入 Bootstrap 框架 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* 动态渐变背景 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 毛玻璃效果和卡片样式 */
        .container {
            margin-top: 50px;
            width: 100%;
            max-width: 900px;
        }
        .card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }

        h1 {
            color: #ffffff;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2rem;
        }

        h2 {
            color: #ffffff;
            margin-bottom: 20px;
            text-align: left;
            font-size: 1.5rem;
        }

        .form-control, .btn-custom {
            border-radius: 20px !important; /* 统一圆角 */
        }

        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: #ffffff;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .btn-custom {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            width: 100%;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: background-color 0.3s ease;
            font-size: 1rem;
        }

        .btn-custom:hover {
            background-color: #0056b3;
        }

        /* 表格的毛玻璃效果和外边框圆角 */
        .table-responsive {
            overflow-x: auto; /* 表格可以水平滚动 */
        }

        table {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            width: 100%;  /* 表格宽度 */
            border-collapse: separate;  /* 保持单元格间距 */
            border-spacing: 0;  /* 移除单元格边距 */
            border-radius: 15px;  /* 外边框圆角 */
            overflow: hidden; /* 避免圆角外边框与内容冲突 */
            border: 1px solid rgba(255, 255, 255, 0.3); /* 确保外边框显示 */
        }

        table th, table td {
            text-align: center;
            vertical-align: middle;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);  /* 内部边框 */
            padding: 12px;
        }

        /* 设置表头的宽度和高度 */
        table th {
            height: 50px; /* 设置表头高度 */
            min-width: 150px; /* 设置表头最小宽度 */
        }

        /* 去掉内边框的圆角效果 */
        table th, table td {
            border-radius: 0 !important;  /* 强制取消内边框的圆角 */
        }

        /* 仅对表格外边框应用圆角 */
        thead th:first-child {
            border-top-left-radius: 15px;
        }

        thead th:last-child {
            border-top-right-radius: 15px;
        }

        tbody tr:last-child td:first-child {
            border-bottom-left-radius: 15px;
        }

        tbody tr:last-child td:last-child {
            border-bottom-right-radius: 15px;
        }

        /* 设置表格列的宽度比例 */
        colgroup col:first-child {
            width: 75%;
        }

        colgroup col:last-child {
            width: 25%;
        }

        .alert {
            margin-top: 20px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            .form-control {
                padding: 8px;
                font-size: 1rem;
            }

            .btn-custom {
                font-size: 0.9rem;
                padding: 10px 15px;
            }

            .card {
                padding: 1.5rem;
            }

            /* 表格列的最小宽度调整，适应小屏 */
            table th {
                min-width: 100px;
            }
        }
    </style>

    <script>
        // CSRF 令牌变量
        let csrfToken = '';

        // 获取 CSRF 令牌
        function getCsrfToken() {
            fetch('/csrf-token')
                .then(response => response.json())
                .then(data => {
                    csrfToken = data.token;
                });
        }

        // 获取白名单并更新表格
        function getWhitelist() {
            fetch('/admin/whitelist')
                .then(response => response.json())
                .then(data => {
                    const table = document.getElementById('whitelistTable');
                    table.innerHTML = '';
                    if (data.length === 0) {
                        table.innerHTML = '<tr><td colspan="2">白名单为空</td></tr>';
                    } else {
                        data.forEach(url => {
                            table.innerHTML += `<tr><td>${url}</td><td><button class="btn btn-danger btn-sm" onclick="removeFromWhitelist('${url}')">删除</button></td></tr>`;
                        });
                    }
                });
        }

        // 添加 URL 到白名单
        function addToWhitelist() {
            const url = document.getElementById('whitelistInput').value;
            if (!url) {
                alert('请输入 URL');
                return;
            }
            fetch(`/admin/whitelist?url=${url}`, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken  // 传递 CSRF 令牌
                }
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                document.getElementById('whitelistInput').value = '';  // 清空输入框
                getWhitelist();  // 更新白名单表格
            });
        }

        // 从白名单中删除 URL
        function removeFromWhitelist(url) {
            fetch(`/admin/whitelist?url=${url}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': csrfToken  // 传递 CSRF 令牌
                }
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                getWhitelist();  // 更新白名单表格
            });
        }

        // 获取当前并发限制
        function getConcurrentLimit() {
            fetch('/admin/concurrent-limit')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('concurrentLimit').value = data;
                });
        }

        // 设置新的并发限制
        function setConcurrentLimit() {
            const limit = document.getElementById('concurrentLimit').value;
            if (limit <= 0) {
                alert('并发限制必须大于 0');
                return;
            }
            fetch(`/admin/concurrent-limit?limit=${limit}`, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken  // 传递 CSRF 令牌
                }
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                window.location.reload();  // 设置完成后刷新页面
            });
        }

        // 获取私钥
        function getPrivateKey() {
            fetch('/admin/private-key')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('privateKey').value = data;
                });
        }

        // 更新私钥
        function updatePrivateKey() {
            const privateKey = document.getElementById('privateKey').value;
            if (!privateKey) {
                alert('请输入私钥');
                return;
            }
            fetch(`/admin/private-key`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRF-TOKEN': csrfToken  // 传递 CSRF 令牌
                },
                body: new URLSearchParams({ privateKey: privateKey })
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                window.location.reload();  // 更新私钥后刷新页面
            });
        }

        // 页面加载时获取数据
        window.onload = function () {
            getWhitelist();
            getConcurrentLimit();
            getPrivateKey();
            getCsrfToken();  // 获取 CSRF 令牌
        };
    </script>
</head>
<body>

    <div class="container">
        <h1 class="text-white">管理员后台</h1>

        <!-- 白名单管理卡片 -->
        <div class="card p-4">
            <h2 class="mb-3">白名单管理</h2>
            <div class="input-group mb-3">
                <input type="text" id="whitelistInput" class="form-control" placeholder="请输入要添加的 URL">
                <button class="btn btn-custom" onclick="addToWhitelist()">添加</button>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <colgroup>
                        <col>
                        <col>
                    </colgroup>
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="whitelistTable">
                        <!-- 动态白名单内容 -->
                    </tbody>
                </table>
            </div>
        </div>
      
        <!-- 并发请求限制卡片 -->
        <div class="card p-4">
            <h2 class="mb-3">并发请求限制</h2>
            <div class="input-group mb-3">
                <input type="number" id="concurrentLimit" class="form-control" placeholder="设置最大并发请求数">
                <button class="btn btn-custom" onclick="setConcurrentLimit()">设置限制</button>
            </div>
        </div>

        <!-- 私钥管理卡片 -->
        <div class="card p-4">
            <h2 class="mb-3">私钥管理</h2>
            <div class="input-group mb-3">
                <textarea id="privateKey" class="form-control" rows="3" placeholder="请输入新的私钥"></textarea>
            </div>
            <button class="btn btn-custom" onclick="updatePrivateKey()">更新私钥</button>
        </div>

    </div>

</body>
</html>
